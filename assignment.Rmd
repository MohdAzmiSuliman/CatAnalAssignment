---
title: "Logistic Regression - Ordinal and Multinomial"
author: "Mohd Azmi"
date: "27/02/2020"
output: html_document
---

#Pre-amble

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Problem Statements

## Environment

```{r}
library(pacman)
p_load(readxl, tidyverse, summarytools, broom, knitr, ordinal, brant)
```

## Dataset & Data Wrangling

```{r, eval=F, echo=T}
dataset <- read_excel("data_ord_prac.xlsx", 
    col_types = c("numeric", "text", "text", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "skip", "skip", 
        "skip", "skip", "skip", "skip", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "text", "text", 
        "text", "text", "text", "text", "text", 
        "skip", "skip", "skip", "skip", "skip", 
        "skip", "skip", "skip", "text", "text", 
        "text"))
head(dataset)
write.csv(dataset,'dataset.csv')
```

### Data Exploration
```{r}
anads0 <- read_csv("dataset.csv", col_types = cols(`Body mass index` = col_skip(), X1 = col_skip()))
head(anads0)
descr(anads0)
freq(anads0)
```

there are some numerical variables that have missing value. missing value will be removed

```{r}
levhba1c <- c("Target 3 (>7.0)", "Target 2 (6.6 - 7.0)", "Target 1 (<= 6.5)")
anads1 <- anads0 %>%
    mutate(HbA1C_T = cut(HbA1c, breaks = c(0, 6.5, 7.0, 20),
                         labels = c("Target 1 (<= 6.5)", "Target 2 (6.6 - 7.0)", "Target 3 (>7.0)"))) %>%
    mutate(HbA1C_Ta = fct_relevel(HbA1C_T, levhba1c)) %>% 
    mutate(HbA1C_Ta = ordered(HbA1C_Ta, levels = levhba1c)) %>%
    mutate(wt = `Physical Weight`,
           gender = Sex,
           ethnic = `Ethnic Group`,
           dmage = `Diabetes Age`,
           ht = `Physical Height`,
           wc = `Physical Waist circumference`,
           tc = `Total Cholesterol`,
           bmi = wt/((ht/100)^2)) %>%
    mutate(bmic = cut(bmi, breaks = c(0, 18.499, 22.999, 26.999, 80),
                      labels = c("underweight", "normal", "overweight", "obese"))) %>% 
    select(HbA1c, HbA1C_Ta, Age, gender, ethnic, dmage, ht, wt, bmi, bmic, wc, tc, Dyslipidaemia) %>%
    filter(Dyslipidaemia == "yes" | Dyslipidaemia == "no") %>%
    drop_na()
head(anads1)
descr(anads1)
freq(anads1)
```

from total 9,457 samples, `r 9457 - 5119` samples with missing data, making only 5,119 sample for analysis.

# Ordinal Logistic Regression

## Univariable

### Age

```{r}
levels(anads1$HbA1C_Ta)
clm_age <- clm(HbA1C_Ta ~ Age, data = anads1)
summary(clm_age)
```

### gender

```{r}
levels(anads1$HbA1C_Ta)
clm_gender <- clm(HbA1C_Ta ~ gender, data = anads1)
summary(clm_gender)
```

## Multivariable

Model 1 - IV - bmicategory, waist circumference, total cholesterol, dyslipidaemia status, gender and age

```{r}
clm_mod1 <- clm(HbA1C_Ta ~ bmic + wc + tc + Dyslipidaemia + gender + Age, data = anads1)
summary(clm_mod1)
```

Model 2 - remove wc

```{r}
clm_mod2 <- clm(HbA1C_Ta ~ bmic + tc + Dyslipidaemia + gender + Age, data = anads1)
summary(clm_mod2)
```

model 3 - remove wc & bmicat

```{r}
clm_mod3 <- clm(HbA1C_Ta ~ tc + Dyslipidaemia + gender + Age, data = anads1)
summary(clm_mod3)
```


### Model comparison

done using LR test

```{r}
anova(clm_mod1, clm_mod2, test="Chisq")
anova(clm_mod2, clm_mod3, test="Chisq")
```

Interpretation: waist circumference can be remove but BMI category was an important predictor.

### Interaction

add interaction term between gender and bmi

```{r}
anads1 %>% group_by(gender) %>% descr()
t.test(anads1$tc ~ anads1$gender)
ctable(anads1$bmic, anads1$gender)
chisq.test(anads1$bmic, anads1$gender)
```

```{r}
clm_mod2ia <- clm(HbA1C_Ta ~ bmic + tc + Dyslipidaemia + gender + Age + gender:tc, data = anads1)
summary(clm_mod2ia)
anova(clm_mod2, clm_mod2ib)

clm_mod2ib <- clm(HbA1C_Ta ~ bmic + tc + Dyslipidaemia + gender + Age + gender:bmic, data = anads1)
summary(clm_mod2ib)
anova(clm_mod2, clm_mod2ib)
```

Interpretation: interaction terms was not significant

### Assumption checking - Proportional odds assumption

### Final Model

```{r}
summary(clm_mod2)
tidy(clm_mod2, conf.int = T)
tidy(clm_mod2, exponentiate = T, conf.int = T)

result_clmmod2 <- matrix(c("Variables", "", "Coefficient", "SE", "p-value", "OR (95% CI)",
                           "Intercept 1", "","","","",""),ncol=6,byrow=TRUE)
result_clmmod2

```



